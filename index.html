<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sfinder Web Environment</title>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
        .left-pane { width: 40%; padding: 15px; background: #f4f4f4; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #ccc; }
        .right-pane { width: 60%; padding: 15px; background: #2d2d2d; color: #eee; display: flex; flex-direction: column; }
        
        textarea { width: 95%; height: 120px; margin-bottom: 10px; font-family: monospace; font-size: 14px; }
        input[type="text"] { width: 95%; padding: 5px; margin-bottom: 10px; font-family: monospace; }
        label { font-weight: bold; font-size: 14px; margin-top: 10px; display: block; }
        
        button { padding: 12px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin-top: 10px; }
        button:disabled { background: #999; cursor: wait; }
        
        #consoleOutput { flex-grow: 1; background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; overflow-y: scroll; border: 1px solid #555; }
        #fileList { margin-top: 10px; padding: 10px; background: #444; border-radius: 4px; min-height: 50px; }
        .download-link { display: block; color: #4da6ff; text-decoration: none; margin: 5px 0; }
        .download-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="left-pane">
        <h2>Sfinder Web</h2>
        
        <label>Command</label>
        <input type="text" id="commandInput" value="path -f input/field.txt -k kicks/srs.properties">
        <small>â€» -k ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç­‰ã¯è‡ªå‹•è¨­å®šæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã¦è¨˜è¿°</small>

        <label>input/field.txt (ç·¨é›†å¯èƒ½)</label>
        <textarea id="fieldTxt">
# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ›
XX________
XX________
XX________
</textarea>

        <label>input/patterns.txt (ç·¨é›†å¯èƒ½)</label>
        <textarea id="patternsTxt">
# ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›
T, I, J, L, S, Z, O
</textarea>

        <button id="runBtn" onclick="runApp()" disabled>CheerpJ æº–å‚™ä¸­...</button>
        <div id="status" style="margin-top:5px; color:#666;">Loading...</div>
    </div>

    <div class="right-pane">
        <label>Console Output</label>
        <div id="consoleOutput"></div>

        <label>Generated Output Files (Download)</label>
        <div id="fileList">å®Ÿè¡ŒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <script>
        // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ï¼škicks/srs.properties ã®ä¸­èº«ã‚’ã“ã“ã«ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ â–¼â–¼â–¼
        const SRS_PROPERTIES_CONTENT = `# srs.properties content
L.NE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.ES=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)
L.SW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WN=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)

L.NW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WS=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)
L.SE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.EN=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)

J.NE=&L.NE
J.ES=&L.ES
J.SW=&L.SW
J.WN=&L.WN

J.NW=&L.NW
J.WS=&L.WS
J.SE=&L.SE
J.EN=&L.EN

S.NE=&L.NE
S.ES=&L.ES
S.SW=&L.SW
S.WN=&L.WN

S.NW=&L.NW
S.WS=&L.WS
S.SE=&L.SE
S.EN=&L.EN

Z.NE=&L.NE
Z.ES=&L.ES
Z.SW=&L.SW
Z.WN=&L.WN

Z.NW=&L.NW
Z.WS=&L.WS
Z.SE=&L.SE
Z.EN=&L.EN

T.NE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.ES=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)
T.SW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WN=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)

T.NW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WS=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)
T.SE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.EN=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)

I.NE=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.ES=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.SW=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)
I.WN=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)

I.NW=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.WS=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.SE=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)
I.EN=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)

O.NE=( 0,+1)
O.ES=(+1, 0)
O.SW=( 0,-1)
O.WN=(-1, 0)

O.NW=(+1, 0)
O.WS=( 0,+1)
O.SE=(-1, 0)
O.EN=( 0,-1)

`;
        // â–²â–²â–² è¨­å®šã‚¨ãƒªã‚¢çµ‚äº† â–²â–²â–²

        // åˆæœŸåŒ–
        (async function init() {
            try {
                await cheerpjInit();
                document.getElementById("status").innerText = "Ready to Run";
                document.getElementById("runBtn").innerText = "å®Ÿè¡Œ (Run Sfinder)";
                document.getElementById("runBtn").disabled = false;
            } catch (e) {
                document.getElementById("status").innerText = "Init Error: " + e;
            }
        })();

        // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
        async function writeVirtualFile(filePath, content) {
            // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
            let folder = filePath.substring(0, filePath.lastIndexOf("/"));
            if (folder) {
                await cjCall("java.io.File", "new", folder).mkdirs();
            }
            // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
            let fileWriter = await cjCall("java.io.FileWriter", "new", filePath);
            await fileWriter.write(content);
            await fileWriter.close();
        }

        // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
        async function runApp() {
            const btn = document.getElementById("runBtn");
            const outputDiv = document.getElementById("consoleOutput");
            const fileListDiv = document.getElementById("fileList");
            
            btn.disabled = true;
            outputDiv.innerText = "Running...\n";
            fileListDiv.innerHTML = "Processing...";

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™
                // å›ºå®šãƒ•ã‚¡ã‚¤ãƒ« (kicks)
                await writeVirtualFile("kicks/srs.properties", SRS_PROPERTIES_CONTENT);
                
                // å¯å¤‰ãƒ•ã‚¡ã‚¤ãƒ« (input)
                await writeVirtualFile("input/field.txt", document.getElementById("fieldTxt").value);
                await writeVirtualFile("input/patterns.txt", document.getElementById("patternsTxt").value);

                // å‡ºåŠ›ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
                // await cjCall("java.io.File", "new", "output").delete(); 

                // 2. ã‚³ãƒãƒ³ãƒ‰å¼•æ•°ã®è§£æ
                // å…¥åŠ›: "path -f input/field.txt" -> é…åˆ—: ["path", "-f", "input/field.txt"]
                let cmdString = document.getElementById("commandInput").value.trim();
                let args = cmdString.split(/\s+/);

                // 3. JARå®Ÿè¡Œ
                // ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¯ entry.EntryPointMain ã¨ä»®å®š
                await cjCall("sfinder.jar", "entry.EntryPointMain", ...args);

                // 4. çµæœãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã¨è¡¨ç¤º
                outputDiv.innerText += "\n[Done]\n";
                await listOutputFiles();

            } catch (e) {
                outputDiv.innerText += "\n[Error] " + e;
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }

        // outputãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œã‚‹
        async function listOutputFiles() {
            const fileListDiv = document.getElementById("fileList");
            fileListDiv.innerHTML = "";

            try {
                const outputDir = await cjCall("java.io.File", "new", "output");
                const exists = await outputDir.exists();
                
                if (!exists) {
                    fileListDiv.innerText = "outputãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                    return;
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾— (String[])
                const filesArray = await outputDir.list();
                
                if (filesArray == null || filesArray.length === 0) {
                    fileListDiv.innerText = "å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                    return;
                }

                // JSã®é…åˆ—ã«å¤‰æ›ã—ã¦ãƒ«ãƒ¼ãƒ—
                for (let i = 0; i < filesArray.length; i++) {
                    let fileName = filesArray[i];
                    
                    // ä¸­èº«ã‚’èª­ã¿è¾¼ã‚€
                    // java.nio.file.Files.readString(...) ã‚’ä½¿ã†ã¨æ¥½ã§ã™ãŒã€
                    // CheerpJã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§ã‚’è€ƒæ…®ã—ã€FileReaderã§èª­ã¿ã¾ã™
                    let pathObj = await cjCall("java.io.File", "new", "output/" + fileName);
                    
                    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
                    if(await pathObj.isDirectory()) continue;

                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå–å¾—
                    let len = await pathObj.length();
                    let charArray = await cjCall("java.lang.reflect.Array", "newInstance", await cjCall("java.lang.Character", "TYPE"), len);
                    let reader = await cjCall("java.io.FileReader", "new", pathObj);
                    // å…¨èª­ã¿è¾¼ã¿ã¯é‡ã„å ´åˆãŒã‚ã‚‹ãŒã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å‰æã§ç°¡æ˜“å®Ÿè£…
                    // ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ãªã©æœ¬æ¥ã¯å¿…è¦ã§ã™ãŒã€ç°¡æ˜“çš„ã« Scanner ã‚’ä½¿ã£ã¦å…¨ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
                    
                    // ã‚‚ã£ã¨ç°¡å˜ãªæ–¹æ³•: Scannerã§åŒºåˆ‡ã‚Šæ–‡å­—\\A(æ–‡é ­)ã‚’æŒ‡å®šã—ã¦å…¨èª­ã¿
                    let scanner = await cjCall("java.util.Scanner", "new", pathObj);
                    await scanner.useDelimiter("\\A");
                    let content = "";
                    if (await scanner.hasNext()) {
                        content = await scanner.next();
                    }
                    await scanner.close();

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ä½œæˆ
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = fileName;
                    link.className = "download-link";
                    link.innerText = "ğŸ“„ " + fileName + " (Click to Download)";
                    fileListDiv.appendChild(link);
                }

            } catch (e) {
                fileListDiv.innerText = "ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼: " + e;
            }
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ãƒ•ãƒƒã‚¯
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            // Sfinderã®ãƒ­ã‚°ã£ã½ããªã„ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¯é™¤å¤–ã™ã‚‹ãªã©ã®å·¥å¤«ã‚‚å¯
            const msg = args.join(" ");
            document.getElementById("consoleOutput").innerText += msg + "\n";
        };
    </script>
</body>
</html>
