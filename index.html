<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sfinder Web (Debug Mode)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: "Segoe UI", sans-serif; background: #222; color: #ddd; }
        .left-pane { width: 40%; padding: 20px; background: #333; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #555; box-sizing: border-box; }
        .right-pane { width: 60%; padding: 20px; background: #1e1e1e; display: flex; flex-direction: column; box-sizing: border-box; }
        textarea { width: 100%; height: 100px; margin-bottom: 15px; background: #444; color: #fff; border: 1px solid #666; padding: 10px; font-family: monospace; box-sizing: border-box; resize: vertical; }
        input[type="text"] { width: 100%; padding: 8px; margin-bottom: 15px; background: #444; color: #fff; border: 1px solid #666; font-family: monospace; box-sizing: border-box; }
        label { font-weight: bold; font-size: 14px; margin-bottom: 5px; display: block; color: #aaa; }
        button { padding: 12px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin-top: 10px; transition: background 0.2s; }
        button:hover { background: #0069d9; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        /* „Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´Âº∑Âåñ */
        #consoleOutput { 
            flex-grow: 1; 
            background: #000; 
            color: #0f0; 
            padding: 15px; 
            font-family: "Consolas", monospace; 
            white-space: pre-wrap; 
            overflow-y: scroll; 
            border: 1px solid #444; 
            margin-bottom: 15px; 
            font-size: 13px; 
        }
        .log-error { color: #ff5555; font-weight: bold; }
        .log-warn { color: #ffcc00; }
        .log-info { color: #0f0; }

        #fileList { padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; min-height: 50px; }
        .download-link { display: inline-block; padding: 5px 10px; background: #444; color: #4da6ff; text-decoration: none; margin: 5px; border-radius: 3px; border: 1px solid #555; }
        .download-link:hover { background: #555; text-decoration: none; }
        .error-msg { color: #ff4d4d; }
    </style>
</head>
<body>
    <div class="left-pane">
        <h2 style="margin-top:0">Sfinder Web</h2>
        
        <script>
            (function(){
                const outputDiv = document.getElementById("consoleOutput"); // „Åæ„Å†DOM„Åå„Å™„ÅÑ„ÅÆ„ÅßÂæå„ÅßÂèñÂæó
                const queue = [];
                
                function appendLog(msg, type) {
                    const el = document.getElementById("consoleOutput");
                    if (!el) {
                        queue.push({msg, type});
                        return;
                    }
                    // „Ç≠„É•„Éº„Åå„ÅÇ„Çå„Å∞ÂÖà„Å´Âêê„ÅçÂá∫„Åô
                    while(queue.length > 0) {
                        const q = queue.shift();
                        appendLog(q.msg, q.type);
                    }

                    const span = document.createElement("div");
                    span.className = type === "error" ? "log-error" : (type === "warn" ? "log-warn" : "log-info");
                    span.innerText = msg;
                    el.appendChild(span);
                    el.scrollTop = el.scrollHeight;
                }

                // console.log / error „Çí‰∏äÊõ∏„Åç„Åó„Å¶ÁîªÈù¢„Å´Âá∫„Åô
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;

                console.log = function(...args) {
                    originalLog.apply(console, args);
                    appendLog(args.join(" "), "info");
                };
                console.error = function(...args) {
                    originalError.apply(console, args);
                    appendLog("[ERROR] " + args.join(" "), "error");
                };
                console.warn = function(...args) {
                    originalWarn.apply(console, args);
                    appendLog("[WARN] " + args.join(" "), "warn");
                };
                
                // „Ç≠„É£„ÉÉ„ÉÅ„Åï„Çå„Å™„ÅÑ„Ç®„É©„Éº„ÇÇË°®Á§∫
                window.addEventListener('error', function(e) {
                    appendLog("[Uncaught Error] " + e.message, "error");
                });
            })();
        </script>

        <label>Command</label>
        <input type="text" id="commandInput" value="path -f input/field.txt -k kicks/srs.properties">
        
        <label>input/field.txt</label>
        <textarea id="fieldTxt">
# „Éï„Ç£„Éº„É´„ÉâÂÖ•Âäõ
XX________
XX________
XX________
</textarea>

        <label>input/patterns.txt</label>
        <textarea id="patternsTxt">
# „Éë„Çø„Éº„É≥ÂÖ•Âäõ
T, I, J, L, S, Z, O
</textarea>

        <button id="runBtn" onclick="runApp()" disabled>Loading CheerpJ...</button>
        <div id="status" style="margin-top:10px; color:#888; font-size: 0.9em;">Initializing...</div>
    </div>

    <div class="right-pane">
        <label>Console Output (Internal Logs & Stdout)</label>
        <div id="consoleOutput">Waiting for execution...</div>

        <label>Generated Output Files</label>
        <div id="fileList"></div>
    </div>

    <script>
// SRSÂÆöÁæ© (Â§âÊõ¥„Å™„Åó)
const SRS_PROPERTIES_CONTENT=`
L.NE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.ES=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)
L.SW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WN=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)

L.NW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,+2)
L.WS=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)
L.SE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.EN=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)

J.NE=&L.NE
J.ES=&L.ES
J.SW=&L.SW
J.WN=&L.WN

J.NW=&L.NW
J.WS=&L.WS
J.SE=&L.SE
J.EN=&L.EN

S.NE=&L.NE
S.ES=&L.ES
S.SW=&L.SW
S.WN=&L.WN

S.NW=&L.NW
S.WS=&L.WS
S.SE=&L.SE
S.EN=&L.EN

Z.NE=&L.NE
Z.ES=&L.ES
Z.SW=&L.SW
Z.WN=&L.WN

Z.NW=&L.NW
Z.WS=&L.WS
Z.SE=&L.SE
Z.EN=&L.EN

T.NE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.ES=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)
T.SW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WN=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)

T.NW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WS=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)
T.SE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.EN=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)

I.NE=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.ES=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.SW=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)
I.WN=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)

I.NW=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.WS=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.SE=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)
I.EN=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)

O.NE=( 0,+1)
O.ES=(+1, 0)
O.SW=( 0,-1)
O.WN=(-1, 0)

O.NW=(+1, 0)
O.WS=( 0,+1)
O.SE=(-1, 0)
O.EN=( 0,-1)
`;

        let logPoller = null;
        let lastLogSize = 0;

        (async function init() {
            try {
                console.log("Initializing CheerpJ...");
                
                // 1. sfinder.jar „ÅåÂÆüÈöõ„Å´„Åù„Åì„Å´„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åô„Çã
                const jarUrl = "sfinder.jar";
                const response = await fetch(jarUrl, { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error(`sfinder.jar not found at ${jarUrl}. Status: ${response.status}`);
                }
                console.log("sfinder.jar found.");

                await cheerpjInit({
                    enablePreciseApp: true, // Ê≠£Á¢∫ÊÄßÈáçË¶ñÔºàÁÑ°„Åè„Å¶„ÇÇÂãï„Åè„ÅåÂÆâÂÆö„Åô„ÇãÔºâ
                    javaProperties: {
                        "java.protocol.handler.pkgs": "com.leaningtech.handlers",
                        "user.dir": "/files/" // ‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÊòéÁ§∫ÁöÑ„Å´‰ªÆÊÉ≥FS„É´„Éº„Éà„Å´„Åô„Çã
                    }
                });
                
                document.getElementById("status").innerText = "Environment Ready. sfinder.jar loaded.";
                document.getElementById("runBtn").innerText = "Run Sfinder";
                document.getElementById("runBtn").disabled = false;
                console.log("CheerpJ Ready.");
            } catch (e) {
                document.getElementById("status").innerText = "Init Error";
                document.getElementById("status").className = "error-msg";
                console.error(e);
            }
        })();

        // ‰ªÆÊÉ≥„Éï„Ç°„Ç§„É´Êõ∏„ÅçËæº„Åø„Éò„É´„Éë„Éº
        async function writeVirtualFile(pathStr, content) {
            const File = await cheerpjRunLibrary("java.io.File");
            const FileWriter = await cheerpjRunLibrary("java.io.FileWriter");
            
            // „Éë„Çπ„Åå /files/ „ÅßÂßã„Åæ„Å£„Å¶„ÅÑ„Å™„Åë„Çå„Å∞‰ªò‰∏é„Åô„ÇãÔºàÂÆâÂÖ®Á≠ñÔºâ
            if (!pathStr.startsWith("/")) {
                pathStr = "/files/" + pathStr;
            }

            console.log(`Writing file to virtual FS: ${pathStr}`);

            // Ë¶™„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
            const fileObj = await new File(pathStr);
            const parent = await fileObj.getParentFile();
            if (parent && !(await parent.exists())) {
                await parent.mkdirs();
            }
            
            const writer = await new FileWriter(fileObj);
            await writer.write(content);
            await writer.close();
        }

        // Ê®ôÊ∫ñÂá∫Âäõ„ÉªÊ®ôÊ∫ñ„Ç®„É©„ÉºÂá∫Âäõ„Çí„Éï„Ç°„Ç§„É´„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åô„Çã
        async function redirectOutputToFile(logPath) {
            console.log(`Redirecting stdout/stderr to: ${logPath}`);
            const FileOutputStream = await cheerpjRunLibrary("java.io.FileOutputStream");
            const PrintStream = await cheerpjRunLibrary("java.io.PrintStream");
            const System = await cheerpjRunLibrary("java.lang.System");
            const File = await cheerpjRunLibrary("java.io.File");

            // „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅÆË¶™„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰Ωú„Çã
            const logFile = await new File(logPath);
            const parent = await logFile.getParentFile();
            if(parent && !(await parent.exists())) {
                await parent.mkdirs();
            }

            // Append mode = false (ÊØéÂõû‰∏äÊõ∏„Åç)
            const fos = await new FileOutputStream(logFile, false);
            // AutoFlush = true
            const ps = await new PrintStream(fos, true);

            await System.setOut(ps);
            await System.setErr(ps);
        }

        async function runApp() {
            const btn = document.getElementById("runBtn");
            btn.disabled = true;
            console.log("\n--- Started Execution ---");
            document.getElementById("fileList").innerHTML = "";

            // „É≠„Ç∞„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
            if (logPoller) clearInterval(logPoller);
            lastLogSize = 0;
            const logPath = "/files/output/session.log"; // Áµ∂ÂØæ„Éë„ÇπÊåáÂÆö

            try {
                // „Éï„Ç°„Ç§„É´Ê∫ñÂÇô
                // sfinder„ÅØ„Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Åã„Çâ„ÅÆÁõ∏ÂØæ„Éë„Çπ„Åß„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô„Åü„ÇÅ
                // /files/input/field.txt „Å™„Å©„Å´ÈÖçÁΩÆ„Åô„Çã
                await writeVirtualFile("kicks/srs.properties", SRS_PROPERTIES_CONTENT);
                await writeVirtualFile("input/field.txt", document.getElementById("fieldTxt").value);
                await writeVirtualFile("input/patterns.txt", document.getElementById("patternsTxt").value);

                // Âá∫ÂäõÂÖà„ÅÆ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàË®≠ÂÆö
                await redirectOutputToFile(logPath);

                // „É≠„Ç∞Áõ£Ë¶ñÈñãÂßã
                logPoller = setInterval(() => checkLogFile(logPath), 200);

                let cmdString = document.getElementById("commandInput").value.trim();
                let args = cmdString.split(/\s+/);
                
                console.log(`Command Args: ${JSON.stringify(args)}`);
                console.log("Invoking sfinder.jar...");

                // JARÂÆüË°å
                // /app/sfinder.jar „ÅØWeb„Çµ„Éº„Éê„Éº‰∏ä„ÅÆ„É´„Éº„Éà„Å´„ÅÇ„Çã sfinder.jar „ÇíÊåá„Åô
                const exitCode = await cheerpjRunJar("/app/sfinder.jar", ...args);
                
                console.log(`--- Finished (Exit Code: ${exitCode}) ---`);
                
            } catch (e) {
                console.error("Execution Fatal Error:");
                console.error(e);
            } finally {
                // ÊúÄÂæå„Å´‰∏ÄÂõû„É≠„Ç∞„ÇíË™≠„Çì„Åß„Åã„ÇâÂÅúÊ≠¢
                await checkLogFile(logPath);
                if (logPoller) clearInterval(logPoller);
                
                await listOutputFiles();
                btn.disabled = false;
            }
        }

        // „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Çì„ÅßÁîªÈù¢„Å´ËøΩË®ò„Åô„ÇãÈñ¢Êï∞
        async function checkLogFile(logPath) {
            try {
                const Paths = await cheerpjRunLibrary("java.nio.file.Paths");
                const Files = await cheerpjRunLibrary("java.nio.file.Files");
                const pathObj = await Paths.get(logPath);
                
                if (!(await Files.exists(pathObj))) return;

                const bytes = await Files.readAllBytes(pathObj);
                if (bytes.length > lastLogSize) {
                    const jsBytes = new Uint8Array(bytes);
                    // Shift_JIS„ÇÑUTF-8„Å™„Å©„ÄÅsfinder„ÅÆ„Ç®„É≥„Ç≥„Éº„Éâ„Å´Âêà„Çè„Åõ„Çã„ÄÇ‰ªäÂõû„ÅØUTF-8„Å®‰ªÆÂÆö
                    const text = new TextDecoder("utf-8").decode(jsBytes);
                    
                    // ÂçòÁ¥î„Å´„É≠„Ç∞„Éï„Ç°„Ç§„É´ÂÖ®‰Ωì„ÇíË°®Á§∫ÔºàÂâçÂõû„ÅÆÂ∑ÆÂàÜ„Å†„ÅëË°®Á§∫„Åô„Çã„ÅÆ„ÅØË§áÈõë„Å™„Åü„ÇÅÔºâ
                    // „É¶„Éº„Ç∂„Éº„ÅÆÁõÆ„Å´Ë¶ã„Åà„ÇãÂΩ¢„ÅßÂº∑Âà∂‰∏äÊõ∏„Åç„Åß„ÅØ„Å™„Åè„ÄÅ
                    // „Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„Ç®„É™„Ç¢„ÅÆ "Êú´Â∞æ" „Å´„Åì„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫„Åó„Åü„ÅÑ„Åå„ÄÅ
                    // „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅØ„ÄåÂÖ®Èáè„Äç„Å™„ÅÆ„Åß„ÄÅ„É≠„Ç∞„Ç®„É™„Ç¢„Çí„ÄåÂÖ®ÈáèÁΩÆÊèõ„Äç„Åó„Åü„Åª„ÅÜ„ÅåËæªË§Ñ„ÅåÂêà„ÅÜ
                    // „Åü„Å†„Åó„ÄÅconsole.log„ÅßÂá∫„Åó„Åü„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇÇÊ∂à„Åà„Å¶„Åó„Åæ„ÅÜ„ÅÆ„Åß„ÄÅ
                    // „Åì„Åì„Åß„ÅØ„Äå„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫„Åô„ÇãÂ∞ÇÁî®„Ç®„É™„Ç¢„Äç„Åå„ÅÇ„Çã„Åπ„Åç„Å†„Åå„ÄÅ
                    // Á∞°ÊòìÁöÑ„Å´ console.log „Å´Âêê„ÅçÂá∫„Åô„Å®„É´„Éº„Éó„Åô„Çã„ÅÆ„Åß„ÄÅ
                    // Áõ¥Êé•DOM„Å´Êõ∏„ÅçËæº„ÇÄÂá¶ÁêÜ„Çí„Åô„Çã
                    
                    // Êó¢Â≠ò„ÅÆ„Ç∑„Çπ„ÉÜ„É†„É≠„Ç∞ÔºàJS„ÅåÂá∫„Åó„Åü„ÇÇ„ÅÆÔºâ„Å®Ê∑∑„Åñ„Çã„Å®Ë¶ã„Å´„Åè„ÅÑ„ÅÆ„Åß
                    // „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÅØ„Äå--- Java Output ---„Äç„Å®„Åó„Å¶ËøΩË®ò„Åô„ÇãÂΩ¢„Å´„Åô„Çã
                    // „Åå„ÄÅ„Éù„Éº„É™„É≥„Ç∞„ÅÆ„Åü„Å≥„Å´ËøΩË®ò„Åô„Çã„Å®ÈáçË§á„Åô„Çã„ÅÆ„Åß„ÄÅ‰ªäÂõû„ÅØ„ÄåÂÖ®Èáè„Äç„Çí
                    // consoleOutput„ÅÆÁâπÂÆö„ÅÆÈÉ®ÂàÜ„Å´Êõ¥Êñ∞„Åô„Çã„Åã„ÄÅ‰∏ÄÁï™‰∏ã„Å´„ÄåÊúÄÊñ∞„ÅÆJava„É≠„Ç∞„Äç„Å®„Åó„Å¶Âá∫„Åô
                    
                    // Á∞°ÊòìÂÆüË£Ö: „É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅÆ‰∏≠Ë∫´„Çí console.log „ÅßÂá∫„ÅôÔºà„Åü„Å†„ÅóÂâçÂõû„Åã„Çâ„ÅÆÂ∑ÆÂàÜ„ÅÆ„ÅøÔºâ
                    const newPart = text.substring(lastLogSize); // „Éê„Ç§„ÉàÊï∞„Åß„ÅØ„Å™„ÅèÊñáÂ≠óÊï∞„Åß„ÅÆ„Ç´„ÉÉ„Éà„ÅØÂç±Èô∫„Å†„Åå„ÄÅASCII„Å™„ÇâOK
                    // Ê≠£Á¢∫„Å´„ÅØ„Éê„Ç§„Éà„Çπ„É©„Ç§„Çπ„Åó„Å¶„Åã„Çâ„Éá„Ç≥„Éº„Éâ„Åô„Åπ„Åç
                    const newTextBytes = jsBytes.slice(lastLogSize);
                    const newText = new TextDecoder("utf-8").decode(newTextBytes);
                    
                    if (newText.length > 0) {
                        // ÁîªÈù¢„Å´Âá∫Âäõ
                        const el = document.getElementById("consoleOutput");
                        const span = document.createElement("div");
                        span.style.color = "#fff";
                        span.innerText = newText;
                        el.appendChild(span);
                        el.scrollTop = el.scrollHeight;
                    }

                    lastLogSize = bytes.length;
                }
            } catch (e) {
                // „Éù„Éº„É™„É≥„Ç∞‰∏≠„ÅÆ„Ç®„É©„Éº„ÅØÈ†ªÁô∫„Åô„Çã„Å®„ÅÜ„Çã„Åï„ÅÑ„ÅÆ„Åßconsole„Å´„ÅØÂá∫„Åï„Å™„ÅÑ
            }
        }

        async function listOutputFiles() {
            const fileListDiv = document.getElementById("fileList");
            fileListDiv.innerHTML = "";
            try {
                const File = await cheerpjRunLibrary("java.io.File");
                const Files = await cheerpjRunLibrary("java.nio.file.Files");
                const Paths = await cheerpjRunLibrary("java.nio.file.Paths");
                
                // sfinder„ÅØ„Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™(/files/)„ÅÆ output „Éï„Ç©„É´„ÉÄ„Å´Âá∫Âäõ„Åô„Çã„ÅØ„Åö
                const outputDir = await new File("/files/output");
                
                if (!(await outputDir.exists())) {
                    console.log("No output directory found.");
                    return;
                }

                const fileArray = await outputDir.list();
                if (!fileArray) {
                    console.log("Output directory is empty or cannot list.");
                    return;
                }

                console.log(`Found ${fileArray.length} files in output.`);

                for (let i = 0; i < fileArray.length; i++) {
                    const name = fileArray[i];
                    if(name.startsWith(".") || name === "session.log") continue; 
                    
                    const fullPath = "/files/output/" + name;
                    const pathObj = await Paths.get(fullPath);
                    const bytes = await Files.readAllBytes(pathObj);
                    const jsBytes = new Uint8Array(bytes);
                    const blob = new Blob([jsBytes], { type: "text/plain" }); 
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = name;
                    link.className = "download-link";
                    link.innerHTML = `üìÑ ${name}`;
                    fileListDiv.appendChild(link);
                }
            } catch (e) {
                console.error("File listing failed", e);
            }
        }
    </script>
</body>
</html>
