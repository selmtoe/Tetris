<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sfinder Web (Diagnostic Mode)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <style>
        body { background: #111; color: #fff; font-family: monospace; padding: 20px; }
        #console { 
            width: 100%; height: 500px; 
            background: #000; border: 1px solid #555; 
            padding: 10px; overflow-y: scroll; white-space: pre-wrap;
            font-size: 14px;
        }
        .log-info { color: #88ff88; }
        .log-warn { color: #ffff88; }
        .log-error { color: #ff8888; font-weight: bold; }
        .log-sys { color: #88ffff; }
        button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Sfinder Web - 診断モード</h2>
    <p>この画面に表示される詳細なログを確認してください。</p>
    
    <div>
        <label>コマンド引数: </label>
        <input type="text" id="argsInput" value="-h" style="width: 300px; padding:5px;">
        <button id="runBtn" onclick="startDiagnosis()">診断実行 (Run)</button>
    </div>
    <br>
    <div id="console">Initializing logger...</div>

    <script>
        // 1. 画面上のコンソールに強制出力する仕組み
        const consoleDiv = document.getElementById("console");
        function screenLog(msg, type = "info") {
            const line = document.createElement("div");
            line.className = "log-" + type;
            line.innerText = `[${type.toUpperCase()}] ${msg}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // 2. ブラウザの隠れたエラーを全部捕まえる
        window.onerror = function(message, source, lineno, colno, error) {
            screenLog(`Global Error: ${message} (${source}:${lineno})`, "error");
            return true;
        };
        window.addEventListener("unhandledrejection", function(event) {
            screenLog(`Unhandled Promise Rejection: ${event.reason}`, "error");
        });

        // 3. console.log / console.error をジャックする
        const originalLog = console.log;
        const originalError = console.error;
        console.log = function(...args) {
            originalLog.apply(console, args);
            screenLog(args.join(" "), "info");
        };
        console.error = function(...args) {
            originalError.apply(console, args);
            screenLog(args.join(" "), "error");
        };

        // --- ここから診断ロジック ---

        async function startDiagnosis() {
            document.getElementById("runBtn").disabled = true;
            consoleDiv.innerHTML = ""; // クリア
            screenLog("--- 診断を開始します ---", "sys");

            try {
                // STEP 1: CheerpJの初期化確認
                screenLog("Step 1: CheerpJのロード中...", "sys");
                if (typeof cheerpjInit === "undefined") {
                    throw new Error("CheerpJのスクリプトがロードされていません。インターネット接続を確認してください。");
                }
                await cheerpjInit({
                    enablePreciseApp: true, // アプリ互換性モード
                    enableUrlLoader: true   // URLからの読み込み許可
                });
                screenLog("OK: CheerpJ Initialized.", "sys");

                // STEP 2: sfinder.jar がブラウザから見えるか確認
                screenLog("Step 2: sfinder.jar のフェッチ確認...", "sys");
                try {
                    const response = await fetch("sfinder.jar", { method: 'HEAD' });
                    if (!response.ok) {
                        throw new Error(`sfinder.jar にアクセスできません。Status: ${response.status}`);
                    }
                    const size = response.headers.get("content-length");
                    screenLog(`OK: sfinder.jar found. Size: ${size} bytes`, "sys");
                    
                    if (size && parseInt(size) < 1000) {
                        screenLog("警告: ファイルサイズが小さすぎます。ダウンロードが正しく行われていない可能性があります。", "warn");
                    }
                } catch (e) {
                    throw new Error("sfinder.jar の読み込みに失敗しました。" + e.message);
                }

                // STEP 3: Java環境の生存確認 (バージョンチェック)
                screenLog("Step 3: Java仮想マシンのテスト実行...", "sys");
                const System = await cheerpjRunLibrary("java.lang.System");
                const version = await System.getProperty("java.version");
                screenLog(`Java Environment Version: ${version}`, "sys");

                // STEP 4: 実際にJARを叩く
                const argsStr = document.getElementById("argsInput").value;
                const args = argsStr.split(" ").filter(s => s.length > 0);
                
                screenLog(`Step 4: sfinder.jar を実行します。引数: [${args}]`, "sys");
                screenLog("--- Java Output Start ---", "sys");

                // ここで実際に実行
                // pathは /app/sfinder.jar にマウントされるのが一般的
                const exitCode = await cheerpjRunJar("/app/sfinder.jar", ...args);

                screenLog(`--- Java Output End ---`, "sys");
                screenLog(`Exit Code: ${exitCode}`, "sys");

                if (exitCode !== 0) {
                    screenLog("異常終了しました。引数が間違っているか、内部エラーです。", "warn");
                }

            } catch (e) {
                screenLog("診断中に致命的なエラーが発生しました:", "error");
                screenLog(e.stack || e, "error");
            } finally {
                document.getElementById("runBtn").disabled = false;
            }
        }
    </script>
</body>
</html>
