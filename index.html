<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sfinder Web (Fixed Output)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: "Segoe UI", sans-serif; background: #222; color: #ddd; }
        .left-pane { width: 40%; padding: 20px; background: #333; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #555; box-sizing: border-box; }
        .right-pane { width: 60%; padding: 20px; background: #1e1e1e; display: flex; flex-direction: column; box-sizing: border-box; }
        textarea { width: 100%; height: 100px; margin-bottom: 15px; background: #444; color: #fff; border: 1px solid #666; padding: 10px; font-family: monospace; box-sizing: border-box; resize: vertical; }
        input[type="text"] { width: 100%; padding: 8px; margin-bottom: 15px; background: #444; color: #fff; border: 1px solid #666; font-family: monospace; box-sizing: border-box; }
        label { font-weight: bold; font-size: 14px; margin-bottom: 5px; display: block; color: #aaa; }
        button { padding: 12px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin-top: 10px; transition: background 0.2s; }
        button:hover { background: #0069d9; }
        button:disabled { background: #555; cursor: not-allowed; }
        #consoleOutput { flex-grow: 1; background: #000; color: #0f0; padding: 15px; font-family: "Consolas", monospace; white-space: pre-wrap; overflow-y: scroll; border: 1px solid #444; margin-bottom: 15px; font-size: 13px; }
        #fileList { padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; min-height: 50px; }
        .download-link { display: inline-block; padding: 5px 10px; background: #444; color: #4da6ff; text-decoration: none; margin: 5px; border-radius: 3px; border: 1px solid #555; }
        .download-link:hover { background: #555; text-decoration: none; }
        .error-msg { color: #ff4d4d; }
    </style>
</head>
<body>
    <div class="left-pane">
        <h2 style="margin-top:0">Sfinder Web</h2>
        
        <label>Command</label>
        <input type="text" id="commandInput" value="path -f input/field.txt -k kicks/srs.properties">
        
        <label>input/field.txt</label>
        <textarea id="fieldTxt">
# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ›
XX________
XX________
XX________
</textarea>

        <label>input/patterns.txt</label>
        <textarea id="patternsTxt">
# ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›
T, I, J, L, S, Z, O
</textarea>

        <button id="runBtn" onclick="runApp()" disabled>Loading CheerpJ...</button>
        <div id="status" style="margin-top:10px; color:#888; font-size: 0.9em;">Initializing...</div>
    </div>

    <div class="right-pane">
        <label>Console Output</label>
        <div id="consoleOutput">Waiting for execution...</div>

        <label>Generated Output Files</label>
        <div id="fileList"></div>
    </div>

    <script>
// SRSå®šç¾© (å¤‰æ›´ãªã—)
const SRS_PROPERTIES_CONTENT=`
L.NE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.ES=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)
L.SW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WN=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)

L.NW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WS=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)
L.SE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.EN=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)

J.NE=&L.NE
J.ES=&L.ES
J.SW=&L.SW
J.WN=&L.WN

J.NW=&L.NW
J.WS=&L.WS
J.SE=&L.SE
J.EN=&L.EN

S.NE=&L.NE
S.ES=&L.ES
S.SW=&L.SW
S.WN=&L.WN

S.NW=&L.NW
S.WS=&L.WS
S.SE=&L.SE
S.EN=&L.EN

Z.NE=&L.NE
Z.ES=&L.ES
Z.SW=&L.SW
Z.WN=&L.WN

Z.NW=&L.NW
Z.WS=&L.WS
Z.SE=&L.SE
Z.EN=&L.EN

T.NE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.ES=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)
T.SW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WN=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)

T.NW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WS=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)
T.SE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.EN=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)

I.NE=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.ES=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.SW=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)
I.WN=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)

I.NW=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.WS=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.SE=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)
I.EN=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)

O.NE=( 0,+1)
O.ES=(+1, 0)
O.SW=( 0,-1)
O.WN=(-1, 0)

O.NW=(+1, 0)
O.WS=( 0,+1)
O.SE=(-1, 0)
O.EN=( 0,-1)
`;

        let logPoller = null;
        let lastLogSize = 0;

        (async function init() {
            try {
                await cheerpjInit();
                document.getElementById("status").innerText = "Environment Ready. sfinder.jar loaded.";
                document.getElementById("runBtn").innerText = "Run Sfinder";
                document.getElementById("runBtn").disabled = false;
            } catch (e) {
                document.getElementById("status").innerText = "Init Error: " + e;
                document.getElementById("status").className = "error-msg";
            }
        })();

        // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
        async function writeVirtualFile(pathStr, content) {
            const File = await cheerpjRunLibrary("java.io.File");
            const FileWriter = await cheerpjRunLibrary("java.io.FileWriter");
            
            // è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
            const fileObj = await new File(pathStr);
            const parent = await fileObj.getParentFile();
            if (parent && !(await parent.exists())) await parent.mkdirs();
            
            const writer = await new FileWriter(pathStr);
            await writer.write(content);
            await writer.close();
        }

        // æ¨™æº–å‡ºåŠ›ãƒ»æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
        async function redirectOutputToFile(logPath) {
            const FileOutputStream = await cheerpjRunLibrary("java.io.FileOutputStream");
            const PrintStream = await cheerpjRunLibrary("java.io.PrintStream");
            const System = await cheerpjRunLibrary("java.lang.System");

            // Append mode = false (æ¯å›ä¸Šæ›¸ãé–‹å§‹)
            const fos = await new FileOutputStream(logPath, false);
            // AutoFlush = true
            const ps = await new PrintStream(fos, true);

            await System.setOut(ps);
            await System.setErr(ps);
        }

        async function runApp() {
            const btn = document.getElementById("runBtn");
            const outputDiv = document.getElementById("consoleOutput");
            btn.disabled = true;
            outputDiv.innerText = "--- Started ---\n";
            document.getElementById("fileList").innerHTML = "";

            // ãƒ­ã‚°ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            if (logPoller) clearInterval(logPoller);
            lastLogSize = 0;
            const logPath = "output/session.log";

            try {
                // JARã®å­˜åœ¨ç¢ºèª (é‡è¦)
                const File = await cheerpjRunLibrary("java.io.File");
                // Webã‚µãƒ¼ãƒä¸Šã®ãƒ‘ã‚¹ã¨CheerpJä¸Šã®ãƒ‘ã‚¹ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒ«ãƒ¼ãƒˆã¯ /app/ ã«ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„
                const jarPath = "/app/sfinder.jar"; 
                const jarFile = await new File(jarPath);
                
                // â€» CheerpJã®ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                // Webã‚µãƒ¼ãƒã‹ã‚‰fetchã§ããªã„å ´åˆã¯ã“ã“ã‚ˆã‚Šä¸‹ã®å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
                
                // ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
                await writeVirtualFile("kicks/srs.properties", SRS_PROPERTIES_CONTENT);
                await writeVirtualFile("input/field.txt", document.getElementById("fieldTxt").value);
                await writeVirtualFile("input/patterns.txt", document.getElementById("patternsTxt").value);

                // å‡ºåŠ›å…ˆã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š
                await redirectOutputToFile(logPath);

                // ãƒ­ã‚°ç›£è¦–é–‹å§‹
                logPoller = setInterval(() => checkLogFile(logPath), 200);

                let cmdString = document.getElementById("commandInput").value.trim();
                let args = cmdString.split(/\s+/);
                
                outputDiv.innerText += `Executing: java -jar sfinder.jar ${args.join(" ")}\n\n`;

                // JARå®Ÿè¡Œ
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é€šå¸¸ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã‚‹ãŒã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã‚‹ã®ã§ log.txt ã«å‡ºã‚‹ã¯ãš
                const exitCode = await cheerpjRunJar(jarPath, ...args);
                
                outputDiv.innerText += `\n--- Finished (Exit Code: ${exitCode}) ---\n`;
                
            } catch (e) {
                outputDiv.innerText += `\n[Fatal Error in JS Layer]\n${e}\n`;
                console.error(e);
            } finally {
                // æœ€å¾Œã«ä¸€å›ãƒ­ã‚°ã‚’èª­ã‚“ã§ã‹ã‚‰åœæ­¢
                await checkLogFile(logPath);
                if (logPoller) clearInterval(logPoller);
                
                await listOutputFiles();
                btn.disabled = false;
            }
        }

        // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç”»é¢ã«è¿½è¨˜ã™ã‚‹é–¢æ•°
        async function checkLogFile(logPath) {
            try {
                const Paths = await cheerpjRunLibrary("java.nio.file.Paths");
                const Files = await cheerpjRunLibrary("java.nio.file.Files");
                const pathObj = await Paths.get(logPath);
                
                if (!(await Files.exists(pathObj))) return;

                const bytes = await Files.readAllBytes(pathObj);
                if (bytes.length > lastLogSize) {
                    // å…¨é‡ã‚’èª­ã‚“ã§å·®åˆ†ã‚’è¡¨ç¤ºã™ã‚‹ã®ã¯é‡ã„ã®ã§ã€ç°¡æ˜“çš„ã«å…¨é‡ç½®æ›ã¾ãŸã¯å·®åˆ†è¨ˆç®—
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨é‡ã‚’TextDecodeã—ã¦è¡¨ç¤º
                    const jsBytes = new Uint8Array(bytes);
                    const text = new TextDecoder("utf-8").decode(jsBytes);
                    
                    // å‰å›ã®é•·ã•ã‚ˆã‚Šé•·ã„éƒ¨åˆ†ã ã‘...ã¨ã„ã†ã®ã¯æ–‡å­—åŒ–ã‘ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã®ã§
                    // å˜ç´”ã«ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’æ›´æ–°ã™ã‚‹
                    const outputDiv = document.getElementById("consoleOutput");
                    // æœ€åˆã® "--- Started ---" ç­‰ã‚’æ®‹ã™ãŸã‚ã®å‡¦ç†ãŒå¿…è¦ãªã‚‰å·¥å¤«ã™ã‚‹ãŒ
                    // ã“ã“ã§ã¯ã€Œãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã€ï¼ã€Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã€ã¨ã™ã‚‹
                    
                    // æ—¢å­˜ã®ãƒ˜ãƒƒãƒ€ã‚’æ®‹ã—ãŸã„å ´åˆ
                    const header = outputDiv.innerText.split("\n\n")[0]; 
                    // â€»ç°¡æ˜“å®Ÿè£…: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãã®ã¾ã¾è¡¨ç¤º
                    outputDiv.innerText = (header.includes("Executing") ? header + "\n\n" : "") + text;
                    outputDiv.scrollTop = outputDiv.scrollHeight;

                    lastLogSize = bytes.length;
                }
            } catch (e) {
                console.error("Log poll error", e);
            }
        }

        async function listOutputFiles() {
            const fileListDiv = document.getElementById("fileList");
            fileListDiv.innerHTML = "";
            try {
                const File = await cheerpjRunLibrary("java.io.File");
                const Files = await cheerpjRunLibrary("java.nio.file.Files");
                const Paths = await cheerpjRunLibrary("java.nio.file.Paths");
                const outputDir = await new File("output");
                
                if (!(await outputDir.exists())) return;

                const fileArray = await outputDir.list();
                if (!fileArray) return;

                for (let i = 0; i < fileArray.length; i++) {
                    const name = fileArray[i];
                    if(name.startsWith(".") || name === "session.log") continue; // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¯DLãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
                    
                    const fullPath = "output/" + name;
                    const pathObj = await Paths.get(fullPath);
                    const bytes = await Files.readAllBytes(pathObj);
                    const jsBytes = new Uint8Array(bytes);
                    const blob = new Blob([jsBytes], { type: "text/plain" }); // ç”»åƒç­‰ã¯MIMEåˆ¤å®šå¿…è¦ã ãŒä¸€æ—¦text
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = name;
                    link.className = "download-link";
                    link.innerHTML = `ğŸ“„ ${name}`;
                    fileListDiv.appendChild(link);
                }
            } catch (e) {
                console.error("File listing failed", e);
            }
        }
    </script>
</body>
</html>
