<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Sfinder Web Environment (CheerpJ 3.0)</title>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
        .left-pane { width: 40%; padding: 15px; background: #f4f4f4; display: flex; flex-direction: column; overflow-y: auto; border-right: 1px solid #ccc; box-sizing: border-box; }
        .right-pane { width: 60%; padding: 15px; background: #2d2d2d; color: #eee; display: flex; flex-direction: column; box-sizing: border-box; }
        
        textarea { width: 100%; height: 120px; margin-bottom: 10px; font-family: monospace; font-size: 14px; box-sizing: border-box; }
        input[type="text"] { width: 100%; padding: 5px; margin-bottom: 10px; font-family: monospace; box-sizing: border-box; }
        label { font-weight: bold; font-size: 14px; margin-top: 10px; display: block; }
        
        button { padding: 12px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; margin-top: 10px; }
        button:disabled { background: #999; cursor: wait; }
        
        #consoleOutput { flex-grow: 1; background: #000; color: #0f0; padding: 10px; font-family: monospace; white-space: pre-wrap; overflow-y: scroll; border: 1px solid #555; height: 300px; }
        #fileList { margin-top: 10px; padding: 10px; background: #444; border-radius: 4px; min-height: 50px; }
        .download-link { display: block; color: #4da6ff; text-decoration: none; margin: 5px 0; }
        .download-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="left-pane">
        <h2>Sfinder Web (Wasm)</h2>
        
        <label>Command</label>
        <input type="text" id="commandInput" value="path -f input/field.txt -k kicks/srs.properties">
        <small>â€» sfinder.jar ã¯è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™</small>

        <label>input/field.txt</label>
        <textarea id="fieldTxt">
# ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ›
XX________
XX________
XX________
</textarea>

        <label>input/patterns.txt</label>
        <textarea id="patternsTxt">
# ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›
T, I, J, L, S, Z, O
</textarea>

        <button id="runBtn" onclick="runApp()" disabled>CheerpJ æº–å‚™ä¸­...</button>
        <div id="status" style="margin-top:5px; color:#666;">Initializing...</div>
    </div>

    <div class="right-pane">
        <label>Console Output</label>
        <div id="consoleOutput"></div>

        <label>Generated Output Files</label>
        <div id="fileList">å®Ÿè¡Œå¾…ã¡</div>
    </div>

    <script>
        // è¨­å®š: kicks/srs.properties ã®å†…å®¹
        const SRS_PROPERTIES_CONTENT = `# srs.properties content
        L.NE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.ES=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)
L.SW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WN=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)

L.NW=(0,0)(+1,0)(+1,+1)(0,-2)(+1,-2)
L.WS=(0,0)(-1,0)(-1,-1)(0,+2)(-1,+2)
L.SE=(0,0)(-1,0)(-1,+1)(0,-2)(-1,-2)
L.EN=(0,0)(+1,0)(+1,-1)(0,+2)(+1,+2)

J.NE=&L.NE
J.ES=&L.ES
J.SW=&L.SW
J.WN=&L.WN

J.NW=&L.NW
J.WS=&L.WS
J.SE=&L.SE
J.EN=&L.EN

S.NE=&L.NE
S.ES=&L.ES
S.SW=&L.SW
S.WN=&L.WN

S.NW=&L.NW
S.WS=&L.WS
S.SE=&L.SE
S.EN=&L.EN

Z.NE=&L.NE
Z.ES=&L.ES
Z.SW=&L.SW
Z.WN=&L.WN

Z.NW=&L.NW
Z.WS=&L.WS
Z.SE=&L.SE
Z.EN=&L.EN

T.NE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.ES=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)
T.SW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WN=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)

T.NW=(0,0)(+1,0)(+1,+1)(0,-2)(@+1,-2)
T.WS=(0,0)(-1,0)(-1,-1)(0,+2)( -1,+2)
T.SE=(0,0)(-1,0)(-1,+1)(0,-2)(@-1,-2)
T.EN=(0,0)(+1,0)(+1,-1)(0,+2)( +1,+2)

I.NE=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.ES=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.SW=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)
I.WN=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)

I.NW=( 0,-1)(-1,-1)(+2,-1)(-1,+1)(+2,-2)
I.WS=(+1, 0)(-1, 0)(+2, 0)(-1,-1)(+2,+2)
I.SE=( 0,+1)(+1,+1)(-2,+1)(+1,-1)(-2,+2)
I.EN=(-1, 0)(+1, 0)(-2, 0)(+1,+1)(-2,-2)

O.NE=( 0,+1)
O.ES=(+1, 0)
O.SW=( 0,-1)
O.WN=(-1, 0)

O.NW=(+1, 0)
O.WS=( 0,+1)
O.SE=(-1, 0)
O.EN=( 0,-1)
`;

        // CheerpJã®åˆæœŸåŒ–
        (async function init() {
            try {
                // 3.0ã®åˆæœŸåŒ–ã€‚status: "splash" ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒ­ãƒ¼ãƒ‰ç”»é¢ãŒå‡ºã‚‹ãŒä»Šå›ã¯è‡ªä½œUIã®ãŸã‚ãªã—
                await cheerpjInit();
                document.getElementById("status").innerText = "Ready";
                document.getElementById("runBtn").innerText = "å®Ÿè¡Œ (Run)";
                document.getElementById("runBtn").disabled = false;
                
                console.log("CheerpJ initialized.");
            } catch (e) {
                document.getElementById("status").innerText = "Error: " + e;
                console.error(e);
            }
        })();

        // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã¸ã®æ›¸ãè¾¼ã¿ (Javaã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨)
        async function writeVirtualFile(pathStr, content) {
            // Javaã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
            const Files = await cheerpjRunLibrary("java.nio.file.Files");
            const Paths = await cheerpjRunLibrary("java.nio.file.Paths");
            const StandardOpenOption = await cheerpjRunLibrary("java.nio.file.StandardOpenOption");
            const StringCls = await cheerpjRunLibrary("java.lang.String");

            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ (Fileã‚¯ãƒ©ã‚¹çµŒç”±ãŒç°¡å˜)
            const File = await cheerpjRunLibrary("java.io.File");
            const fileObj = await new File(pathStr);
            const parent = await fileObj.getParentFile();
            if (parent) {
                await parent.mkdirs();
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ (Files.writeString ã¯ Java11+ã€‚CheerpJã¯åŸºæœ¬Java8äº’æ›ãƒ™ãƒ¼ã‚¹ã ãŒã€
            // å®‰å…¨ã®ãŸã‚ã«FileWriterã‚’ä½¿ã†å¤ã„æ–¹å¼ã§å®Ÿè£…ã—ã¾ã™)
            const FileWriter = await cheerpjRunLibrary("java.io.FileWriter");
            const writer = await new FileWriter(pathStr);
            await writer.write(content);
            await writer.close();
        }

        async function runApp() {
            const btn = document.getElementById("runBtn");
            const outputDiv = document.getElementById("consoleOutput");
            
            btn.disabled = true;
            outputDiv.innerText = "Processing...\n";

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
                // sfinderã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  (/app/ ãŒãƒ«ãƒ¼ãƒˆç›¸å½“)
                await writeVirtualFile("kicks/srs.properties", SRS_PROPERTIES_CONTENT);
                await writeVirtualFile("input/field.txt", document.getElementById("fieldTxt").value);
                await writeVirtualFile("input/patterns.txt", document.getElementById("patternsTxt").value);

                // 2. ã‚³ãƒãƒ³ãƒ‰å¼•æ•°ã®å‡¦ç†
                // "path -f input/field.txt ..." ã‚’åˆ†å‰²
                let cmdString = document.getElementById("commandInput").value.trim();
                let args = cmdString.split(/\s+/);

                // 3. JARã®å®Ÿè¡Œ
                // /app/sfinder.jar ã¯ã€HTMLã¨åŒã˜å ´æ‰€ã«ã‚ã‚‹å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’CheerpJãŒãƒ•ã‚§ãƒƒãƒã—ã¾ã™
                const exitCode = await cheerpjRunJar("/app/sfinder.jar", ...args);
                
                outputDiv.innerText += `\n[Process Finished with exit code ${exitCode}]\n`;

                // 4. outputãƒ•ã‚©ãƒ«ãƒ€ã®çµæœã‚’è¡¨ç¤º
                await listOutputFiles();

            } catch (e) {
                outputDiv.innerText += `\n[Error] ${e}\n`;
                console.error(e);
            } finally {
                btn.disabled = false;
            }
        }

        async function listOutputFiles() {
            const fileListDiv = document.getElementById("fileList");
            fileListDiv.innerHTML = "";

            try {
                const File = await cheerpjRunLibrary("java.io.File");
                const outputDir = await new File("output");
                
                if (!(await outputDir.exists()) || !(await outputDir.isDirectory())) {
                    fileListDiv.innerText = "outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                    return;
                }

                const files = await outputDir.list();
                if (!files) {
                    fileListDiv.innerText = "å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãªã—";
                    return;
                }

                // Javaé…åˆ—ã‚’JSã§ãƒ«ãƒ¼ãƒ—ã™ã‚‹å ´åˆã€CheerpJ 3.0ã§ã¯å°‘ã—å·¥å¤«ãŒå¿…è¦
                // å˜ç´”ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯åŒ–
                for (let i = 0; i < files.length; i++) {
                    let fileName = files[i];
                    let fullPath = "output/" + fileName;

                    // ä¸­èº«ã‚’èª­ã‚€
                    const Path = await cheerpjRunLibrary("java.nio.file.Paths");
                    const Files = await cheerpjRunLibrary("java.nio.file.Files");
                    const pathObj = await Path.get(fullPath);
                    
                    // ãƒã‚¤ãƒŠãƒªã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§BlobåŒ–
                    const bytes = await Files.readAllBytes(pathObj);
                    // Javaã®byteé…åˆ—ã‚’JSã®Uint8Arrayã«å¤‰æ›
                    const jsBytes = new Uint8Array(bytes);
                    
                    const blob = new Blob([jsBytes], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);

                    const link = document.createElement("a");
                    link.href = url;
                    link.download = fileName;
                    link.className = "download-link";
                    link.innerText = `ğŸ“„ ${fileName}`;
                    fileListDiv.appendChild(link);
                }
            } catch (e) {
                fileListDiv.innerText = "çµæœå–å¾—ã‚¨ãƒ©ãƒ¼: " + e;
                console.error(e);
            }
        }

        // æ¨™æº–å‡ºåŠ›ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯
        // CheerpJã¯console.logã«stdoutã‚’æµã™ãŸã‚ã€ãã‚Œã‚’æ¨ªå–ã‚Šã—ã¾ã™
        const originalLog = console.log;
        const outputDiv = document.getElementById("consoleOutput");
        console.log = function(...args) {
            originalLog.apply(console, args);
            // Sfinderå®Ÿè¡Œä¸­ã®ãƒ­ã‚°ã£ã½ã„ã‚‚ã®ã ã‘è¡¨ç¤ºã™ã‚‹ç°¡æ˜“ãƒ•ã‚£ãƒ«ã‚¿
            const msg = args.join(" ");
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã‚’è¡¨ç¤º
            outputDiv.innerText += msg + "\n";
            outputDiv.scrollTop = outputDiv.scrollHeight;
        };
    </script>
</body>
</html>
